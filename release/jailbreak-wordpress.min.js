/**
* jailbreak-wordpress
 * Breaks themes out of jail.
 *
 * @author Ted Benson and Sarah Scodel
 * @copyright MIT CSAIL Haystack Group 2013
 * @license MIT <http://github.com/webcats/dscrape/blob/master/LICENSE.txt>
 * @link 
 * @module jailbreak-wordpress
 * @version 0.0.1
 */

(function(){var e=require("underscore");typeof Jailbreak=="undefined"&&(Jailbreak={}),Jailbreak.Theme=function(e,t,n){this.name=e,this.directory=t,this.filename=path.join(t,e+".json"),this.contentMap=n,this.data={sources:{},mockups:{},treesheets:{},stylesheets:{},javascripts:{},pipelineStatus:{},images:{}},this.initialize()},Jailbreak.Theme.prototype.initialize=function(e){console.log("[Theme] Initializing: ",this.name),this.loadFromFile()},Jailbreak.Theme.prototype.loadFromFile=function(){if(fs.existsSync(this.filename))try{var e=fs.readFileSync(this.filename,"utf-8");this.data=JSON.parse(e)}catch(t){console.log("Could not fead file",this.filename)}else console.log("No existing themefile for",this.filename)},Jailbreak.Theme.prototype.saveToFile=function(){try{var e=JSON.stringify(this.data);fs.writeFileSync(this.filename,e,"utf8")}catch(t){console.log("Could not write file",this.filename)}},typeof Jailbreak=="undefined"&&(Jailbreak={}),Jailbreak.ContentPage=function(){this.url=null,this.name=null},Jailbreak.ContentPage.prototype.reset=function(){this.name=null,this.path=null},Jailbreak.ContentPage.prototype.loadFromJson=function(e,t){this.reset(),typeof e.path!="undefined"&&(this.path=e.path),typeof e.name!="undefined"&&(this.name=e.name)},typeof Jailbreak=="undefined"&&(Jailbreak={}),Jailbreak.ContentMap=function(e){this.pages=[],this.name=null,this.domain=null,this.loadFromFile(e)},Jailbreak.ContentMap.prototype.reset=function(){this.pages=[],this.name=null,this.domain=null},Jailbreak.ContentMap.prototype.loadFromFile=function(e){if(fs.existsSync(e))try{var t=fs.readFileSync(e,"utf-8");this.loadFromJson(JSON.parse(t))}catch(n){console.log("Could not read file",e),console.log(n)}else console.log("No existing content map file for",e)},Jailbreak.ContentMap.prototype.loadFromJson=function(e){this.reset(),typeof e.name!="undefined"&&(this.name=e.name),typeof e.domain!="undefined"&&(this.domain=e.domain);if(typeof e.pages!="undefined")for(var t=0;t<e.pages.length;t++){var n=e.pages[t],r=new Jailbreak.ContentPage;r.loadFromJson(n,this),this.pages[this.pages.length]=r}},typeof Jailbreak=="undefined"&&(Jailbreak={}),typeof Jailbreak.Pipeline=="undefined"&&(Jailbreak.Pipeline={}),Jailbreak.Pipeline.log=function(e,t){console.log("["+e.name+"] "+t)},Jailbreak.Pipeline.FetchPages=function(e,t){this.name="Fetch Pages",this.self=this},Jailbreak.Pipeline.FetchPages.prototype.run=function(e,t){var n=e.contentMap.domain,r=[],i=this;for(var s=0;s<e.contentMap.pages.length;s++){var o=e.contentMap.pages[s].name,u=e.contentMap.pages[s].path;r.push(u),Jailbreak.Pipeline.log(i,"Scraping "+o+": "+u)}var a=require("util"),f=require("url"),l=require("http-agent"),c=require("jsdom").jsdom,h=l.create(n,r);count=0,h.addListener("next",function(n,r){n&&(Jailbreak.Pipeline.log(i,"error: "+n),t.advance(i,e,{success:!1})),e.data.sources[e.contentMap.pages[count].name]=r.body,count++,r.next()}),h.addListener("stop",function(n,r){t.advance(i,e,{success:!0})}),h.start()},Jailbreak.Pipeline.FetchAssets=function(e){this.name="Fetch Assets"},Jailbreak.Pipeline.FetchAssets.prototype.run=function(e,t){var n=this,r=function(){var t=function(e,t){var n=require("request");n(e,function(n,r,i){!n&&r.statusCode==200&&(t[e]=i)})},n=function(n){var r=require("jsdom").jsdom,i=r(n).createWindow(),s=require("jquery").create(i);s("img").map(function(){e.data.images[this.src]=!0}),s("link[type*=css]").map(function(){t(this.href,e.data.stylesheets)}),s("script[type*=javascript]").map(function(){this.src&&t(this.src,e.data.javascripts)})};for(var r in e.data.sources)e.data.sources.hasOwnProperty(r)&&n(e.data.sources[r])};setTimeout(r,2e3);var i=function(){Jailbreak.Pipeline.log(n,"see this at end");for(var t in e.data.stylesheets)e.data.stylesheets.hasOwnProperty(t)&&Jailbreak.Pipeline.log(n,t)};setTimeout(i,4e3),t.advance(n,e,{success:!0})},Jailbreak.Pipeline.FixAssets=function(e,t){this.name="Fix Assets"},Jailbreak.Pipeline.FixAssets.prototype.run=function(e,t){t.advance(this,e,{success:!0})},Jailbreak.Pipeline.Pipeline=function(){this.name="Pipeline",this.stages=[new Jailbreak.Pipeline.FetchPages,new Jailbreak.Pipeline.FetchAssets]},Jailbreak.Pipeline.Pipeline.prototype.run=function(e){Jailbreak.Pipeline.log(this,"Running Stage: "+this.stages[0].name),this.stages[0].run(e,this)},Jailbreak.Pipeline.Pipeline.prototype.advance=function(t,n,r){n.data.pipelineStatus[t.name]=r,n.saveToFile();if(r.success){var i=e.indexOf(this.stages,t)+1;i==-1?Jailbreak.Pipeline.log(this,"Error: can't figure out where I am"):i<this.stages.length?(Jailbreak.Pipeline.log(this,"Running Stage: "+this.stages[i].name),this.stages[i].run(n,this)):Jailbreak.Pipeline.log(this,"Pipeline complete")}else Jailbreak.Pipeline.log(this,"Aborting pipeline because of bad result.")}}).call(this),fs=require("fs"),path=require("path"),optimist=require("optimist"),printLine=function(e){process.stdout.write(e+"\n")},printError=function(e){process.stderr.write(e+"\n")},BANNER="Usage: jailbreak-wordpress <Workspace> <ThemeName> [ContentMap]",exports.run=function(){var e=optimist.usage(BANNER).argv;if(e._.length<2)return optimist.showHelp(),!1;var t=e._[0],n=e._[1],r=e._[2],i=path.join(t,n);fs.existsSync(t)||fs.mkdirSync(t),fs.existsSync(i)||fs.mkdirSync(i);var s=new Jailbreak.Pipeline.Pipeline,o=new Jailbreak.ContentMap(r),u=new Jailbreak.Theme(n,i,o);s.run(u)};
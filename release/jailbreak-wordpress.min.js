/**
* jailbreak-wordpress
 * Breaks themes out of jail.
 *
 * @author Ted Benson and Sarah Scodel
 * @copyright MIT CSAIL Haystack Group 2013
 * @license MIT <http://github.com/webcats/dscrape/blob/master/LICENSE.txt>
 * @link 
 * @module jailbreak-wordpress
 * @version 0.0.1
 */

(function(){var t=require("underscore");typeof Jailbreak=="undefined"&&(Jailbreak={}),Jailbreak.Theme=function(e,t,n){this.name=e,this.directory=t,this.filename=path.join(t,e+".json"),this.contentMap=n,this.data={sources:{},fixedSources:{},mockups:{},treesheets:{},stylesheets:{},javascripts:{},pipelineStatus:{},images:{},newClasses:{}},this.initialize()},Jailbreak.Theme.prototype.initialize=function(e){console.log("[Theme] Initializing: ",this.name),this.loadFromFile()},Jailbreak.Theme.prototype.loadFromFile=function(){if(fs.existsSync(this.filename))try{var e=fs.readFileSync(this.filename,"utf-8");this.data=JSON.parse(e)}catch(t){console.log("Could not fead file",this.filename)}else console.log("No existing themefile for",this.filename)},Jailbreak.Theme.prototype.saveToFile=function(){try{var e=JSON.stringify(this.data);fs.writeFileSync(this.filename,e,"utf8")}catch(t){console.log("Could not write file",this.filename)}},typeof Jailbreak=="undefined"&&(Jailbreak={}),Jailbreak.ContentPage=function(){this.url=null,this.name=null},Jailbreak.ContentPage.prototype.reset=function(){this.name=null,this.path=null,this.data=null},Jailbreak.ContentPage.prototype.loadFromJson=function(e,t){this.reset(),typeof e.path!="undefined"&&(this.path=e.path),typeof e.name!="undefined"&&(this.name=e.name),typeof e.data!="undefined"&&(this.data=e.data)},typeof Jailbreak=="undefined"&&(Jailbreak={}),Jailbreak.ContentMap=function(e){this.pages=[],this.name=null,this.domain=null,this.loadFromFile(e)},Jailbreak.ContentMap.prototype.reset=function(){this.pages=[],this.name=null,this.domain=null},Jailbreak.ContentMap.prototype.loadFromFile=function(e){if(fs.existsSync(e))try{var t=fs.readFileSync(e,"utf-8");this.loadFromJson(JSON.parse(t))}catch(n){console.log("Could not read file",e),console.log(n)}else console.log("No existing content map file for",e)},Jailbreak.ContentMap.prototype.loadFromJson=function(e){this.reset(),typeof e.name!="undefined"&&(this.name=e.name),typeof e.domain!="undefined"&&(this.domain=e.domain);if(typeof e.pages!="undefined")for(var t=0;t<e.pages.length;t++){var n=e.pages[t],r=new Jailbreak.ContentPage;r.loadFromJson(n,this),this.pages[this.pages.length]=r}},typeof Jailbreak=="undefined"&&(Jailbreak={}),typeof Jailbreak.Pipeline=="undefined"&&(Jailbreak.Pipeline={}),Jailbreak.Pipeline.log=function(e,t){console.log("["+e.name+"] "+t)},Jailbreak.Pipeline.FetchPages=function(e,t){this.name="Fetch Pages",this.self=this},Jailbreak.Pipeline.FetchPages.prototype.run=function(e,t){var n=e.contentMap.domain,r=[],i=this;for(var s=0;s<e.contentMap.pages.length;s++){var o=e.contentMap.pages[s].name,u=e.contentMap.pages[s].path;r.push(u),Jailbreak.Pipeline.log(i,"Scraping "+o+": "+u)}var a=require("util"),f=require("url"),l=require("http-agent"),c=require("jsdom").jsdom,h=l.create(n,r);count=0,h.addListener("next",function(n,r){n&&(Jailbreak.Pipeline.log(i,"error: "+n),t.advance(i,e,{success:!1})),e.data.sources[e.contentMap.pages[count].name]=r.body,count++,r.next()}),h.addListener("stop",function(n,r){t.advance(i,e,{success:!0})}),h.start()},Jailbreak.Pipeline.FetchAssets=function(e){this.name="Fetch Assets",this.pageQueue={},this.assetQueue={}},Jailbreak.Pipeline.FetchAssets.prototype.run=function(e,t){this.queuePages(e,t)},Jailbreak.Pipeline.FetchAssets.prototype.queuePages=function(e,n){t.each(e.data.sources,function(e,t){Jailbreak.Pipeline.log(this,"Queueing page asset fetch for: "+t),this.pageQueue[t]=e},this),this.queueAssets(e,n)},Jailbreak.Pipeline.FetchAssets.prototype.queueAssets=function(e,n){var r=this,i=function(e){return e.substring(0,2)=="//"&&(e="http:"+e),e},s=require("jsuri"),o=function(e){var t=new s(e),n=t.path().split("/"),r=n[n.length-1];if(r===null||r.length===0){var i=new Date;r="AutoGen_"+i.getTime()+".js"}return r};t.each(t.clone(this.pageQueue),function(s,u){var a=require("jsdom");a.env({html:s,scripts:["http://code.jquery.com/jquery.js"],done:function(s,a){console.log(s);var f=a.$;f("img").map(function(){Jailbreak.Pipeline.log(r,"Queueing asset fetch for: "+u+": "+this.src);var e=i(this.src),t=o(e);r.assetQueue[e]={filename:t,type:"img"},this.sec="images/"+t}),f("link[type*=css]").map(function(){if(this.href){Jailbreak.Pipeline.log(r,"Queueing asset fetch for: "+u+": "+this.href);var e=i(this.href),t=o(e);r.assetQueue[e]={filename:t,type:"css"},this.href="stylesheets/"+t}}),f("script[type*=javascript]").map(function(){if(this.src){Jailbreak.Pipeline.log(r,"Queueing asset fetch for: "+u+": "+this.src);var e=i(this.src),t=o(e);r.assetQueue[e]={filename:t,type:"js"},this.src="javascripts/"+t,console.log("SRC:",this.src)}}),e.data.fixedSources[u]=a.document.documentElement.innerHTML,delete r.pageQueue[u],t.keys(r.pageQueue).length===0&&r.fetchAssets(e,n)}})},this)},Jailbreak.Pipeline.FetchAssets.prototype.fetchAssets=function(n,r){var i=this,s=function(e){delete i.assetQueue[e],t.keys(i.assetQueue).length===0&&(Jailbreak.Pipeline.log(i,"Finished fetching assets!"),r.advance(i,n,{success:!0}))};t.each(t.clone(this.assetQueue),function(t,o){var u=require("request");u({uri:o},function(u,a,f){!u&&a.statusCode==200?(f?t.data=f:t.data="",Jailbreak.Pipeline.log(i,"Fetched "+o),t.type=="js"?n.data.javascripts[o]=t:t.type=="css"?n.data.stylesheets[o]=t:t.type=="img"?n.data.images[o]=t:Jailbreak.Pipeline.log(i,"Warning: unknown content type: "+t.type),s(o)):(Jailbreak.Pipeline.log(i,"error "+e),r.advance(i,n,{success:!1}))})},this)},Jailbreak.Pipeline.AnnotateDom=function(e){this.name="Annotate Dom",this.self=this,this.pageDataQueue={}},Jailbreak.Pipeline.AnnotateDom.prototype.run=function(e,n){var r=this;for(var i=0;i<e.contentMap.pages.length;i++){var s=e.contentMap.pages[i],o=s.data,u={};if(o){for(var a=0;a<t.keys(o).length;a++){var f=t.keys(o)[a];u[f]=null}u.repeats=[],this.pageDataQueue[s.name]=o,e.data.newClasses[s.name]=u}}this.queuePages(e,n)},Jailbreak.Pipeline.AnnotateDom.prototype.queuePages=function(e,n){var r=this;t.each(t.clone(this.pageDataQueue),function(i,s){var o=e.data.sources[s],u=require("jsdom");u.env({html:o,scripts:["http://code.jquery.com/jquery.js"],done:function(o,u){console.log(o);var a=u.$,f=a("*").filter(function(e){var t=a(this).children().length<=1;return t}).map(function(){for(var n=0;n<t.pairs(i).length;n++){var r=t.pairs(i)[n][0],o=t.pairs(i)[n][1];this.innerHTML===o&&(this.className=r,e.data.newClasses[s][r]="innerHTML");for(var u=0;u<this.attributes.length;u++)this.attributes[u].value==o&&(this.className=r,e.data.newClasses[s][r]=this.attributes[u].name)}}),l=i.repeats;if(l)for(var c=0;c<l.length;c++){var h=l[c],p={},d=0,v=1;h.offset&&(d=Number(h.offset)),h.step&&(v=Number(h.step)),a(h.selector).addClass(h.newClass),p.name=h.newClass,p.offset=d,p.step=v,p.content=[];for(var m=0;m<t.pairs(h.content).length;m++){var g=t.pairs(h.content)[m][0],y=t.pairs(h.content)[m][1];a(h.selector).find(y).addClass(g),p.content.push(g)}e.data.newClasses[s].repeats.push(p)}e.data.mockups[s]=u.document.innerHTML,delete r.pageDataQueue[s],t.keys(r.pageDataQueue).length===0&&n.advance(r,e,{success:!0})}})},this)},Jailbreak.Pipeline.OutputFiles=function(e,t){this.name="Output Files",this.self=this},Jailbreak.Pipeline.OutputFiles.prototype.writeFiles=function(e,n,r){var i=path.join(e.directory,r);fs.existsSync(i)||fs.mkdirSync(i),t.each(n,function(e,t){var n="",r="";typeof e=="object"?(r=e.filename,n=e.date):(r=t+".html",n=e);try{var s=path.join(i,r);Jailbreak.Pipeline.log(this,"Writing "+s),fs.writeFileSync(s,n,"utf8")}catch(o){console.log("Could not write file",s,o)}},this)},Jailbreak.Pipeline.OutputFiles.prototype.writeCTSSheets=function(e,n,r){var i=function(e,t){var n="";if(e==="repeats"){var r=t;for(var i=0;i<r.length;i++){var s=r[i];n+="."+s.name+" { \n",n+="  repeat: "+s.name+"\n",n+="  repeat-offset: "+s.offset+"\n",n+="  repeat-step: "+s.step+"\n",n+="}\n";for(var o=0;o<s.content.length;o++)n+="."+s.name+" ."+s.content[o]+" { \n",n+="  value: "+s.content[o]+"\n",n+="} \n"}}else t==="innerHTML"?(n="."+e+" { \n",n+="  value: "+e+" \n",n+="} \n"):t&&(n="."+e+" { \n",n+="  value(@"+t+"): "+e+" \n",n+="} \n");return console.log("adding rule: "+n),n},s=path.join(e.directory,r);fs.existsSync(s)||fs.mkdirSync(s),t.each(n,function(e,n){var r="",o=n+".cts";try{var u=path.join(s,o);Jailbreak.Pipeline.log(this,"Writing "+u),t.each(e,function(e,t){r+=i(t,e)},this),fs.writeFileSync(u,r,"utf8")}catch(a){console.log("Could not write file",u,a)}},this)},Jailbreak.Pipeline.OutputFiles.prototype.run=function(e,t){this.writeFiles(e,e.data.sources,"sources"),this.writeFiles(e,e.data.fixedSources,"fixedSources"),this.writeFiles(e,e.data.images,"images"),this.writeFiles(e,e.data.javascripts,"javascripts"),this.writeFiles(e,e.data.mockups,"mockups"),this.writeFiles(e,e.data.stylesheets,"stylesheets"),this.writeCTSSheets(e,e.data.newClasses,"ctsSheets"),t.advance(this,e,{success:!0})},Jailbreak.Pipeline.Pipeline=function(e){this.name="Pipeline",this.stages=[new Jailbreak.Pipeline.FetchPages,new Jailbreak.Pipeline.FetchAssets,new Jailbreak.Pipeline.AnnotateDom,new Jailbreak.Pipeline.OutputFiles]},Jailbreak.Pipeline.Pipeline.prototype.run=function(e){Jailbreak.Pipeline.log(this,"Running Stage: "+this.stages[0].name),this.stages[0].run(e,this)},Jailbreak.Pipeline.Pipeline.prototype.printTheme=function(e){Jailbreak.Pipeline.log(this,"Printing keys from sources");for(var t in e.data.sources)e.data.sources.hasOwnProperty(t)&&Jailbreak.Pipeline.log(this,"sources file: "+t);Jailbreak.Pipeline.log(this,"Printing keys from images");for(var n in e.data.images)e.data.images.hasOwnProperty(n)&&Jailbreak.Pipeline.log(this,"image  file: "+n);Jailbreak.Pipeline.log(this,"Printing keys from javascripts");for(var r in e.data.javascripts)e.data.javascripts.hasOwnProperty(r)&&Jailbreak.Pipeline.log(this,"javascript file: "+r);Jailbreak.Pipeline.log(this,"Printing keys from stylesheets");for(var i in e.data.stylesheets)e.data.stylesheets.hasOwnProperty(i)&&Jailbreak.Pipeline.log(this,"stylesheet file: "+i)},Jailbreak.Pipeline.Pipeline.prototype.printData=function(e){Jailbreak.Pipeline.log(this,"printing data from "+e);for(var t in e)e.hasOwnProperty(t)&&Jailbreak.Pipeline.log(this,t)},Jailbreak.Pipeline.Pipeline.prototype.advance=function(e,n,r){n.data.pipelineStatus[e.name]=r,n.saveToFile();if(r.success){var i=t.indexOf(this.stages,e)+1;i==-1?Jailbreak.Pipeline.log(this,"Error: can't figure out where I am"):i<this.stages.length?(Jailbreak.Pipeline.log(this,"Running Stage: "+this.stages[i].name),this.stages[i].run(n,this)):Jailbreak.Pipeline.log(this,"Pipeline complete")}else Jailbreak.Pipeline.log(this,"Aborting pipeline because of bad result.")}}).call(this),fs=require("fs"),path=require("path"),optimist=require("optimist"),printLine=function(e){process.stdout.write(e+"\n")},printError=function(e){process.stderr.write(e+"\n")},BANNER="Usage: jailbreak-wordpress <Workspace> <ThemeName> [ContentMap]",exports.run=function(){var e=optimist.usage(BANNER).argv;if(e._.length<2)return optimist.showHelp(),!1;var t=e._[0],n=e._[1],r=e._[2],i=path.join(t,n);fs.existsSync(t)||fs.mkdirSync(t),fs.existsSync(i)||fs.mkdirSync(i);var s=new Jailbreak.Pipeline.Pipeline,o=new Jailbreak.ContentMap(r),u=new Jailbreak.Theme(n,i,o);s.run(u)};